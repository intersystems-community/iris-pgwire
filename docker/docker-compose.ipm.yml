version: '3.8'

services:
  # IRIS instance for IPM testing
  iris:
    image: containers.intersystems.com/intersystems/iris:latest-preview
    container_name: iris-pgwire-test
    ports:
      - "127.0.0.1:1972:1972"    # SuperServer port
      - "127.0.0.1:52773:52773"  # Management portal
      - "127.0.0.1:5432:5432"    # PGWire server port (after IPM install)
    environment:
      - IRIS_USERNAME=_SYSTEM
      - IRIS_PASSWORD=SYS
      - IRIS_NAMESPACE=USER
    volumes:
      # Mount IPM package for testing
      - ../ipm:/opt/ipm/iris-pgwire:ro
      # Mount merge.cpf for CallIn service enablement
      - ./merge.cpf:/opt/merge.cpf:ro
    command: |
      --check-caps false
      --ISCAgent false

  # Test client for validation
  pgwire-test:
    image: postgres:16-alpine
    container_name: pgwire-test-client
    depends_on:
      - iris
    environment:
      - PGHOST=iris
      - PGPORT=5432
      - PGUSER=_SYSTEM
      - PGPASSWORD=SYS
      - PGDATABASE=USER
    volumes:
      - ../tests:/tests:ro
    command: |
      sh -c "
        echo 'Waiting for PGWire server to start...'
        sleep 10
        echo 'Testing connection...'
        psql -c 'SELECT 1 AS test'
      "

networks:
  default:
    name: iris-pgwire-test-network
