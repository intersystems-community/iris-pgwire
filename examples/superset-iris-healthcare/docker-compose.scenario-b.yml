# Scenario B: PostgreSQL Metadata + Native IRIS Driver for Data Source
#
# What this demonstrates:
# - Superset metadata stored in PostgreSQL (proven stable)
# - Data source uses native IRIS SQLAlchemy driver (iris:// URI)
# - Direct connection to IRIS on port 1972 (no PGWire translation)
#
# Key Difference from Scenario A:
# - Uses sqlalchemy-intersystems-iris driver instead of PostgreSQL driver
# - Connection: iris://_SYSTEM:SYS@iris:1972/USER
# - Requires IRIS-specific driver installation in Superset container
#
# Usage:
#   docker-compose -f docker-compose.yml \
#                  -f examples/superset-iris-healthcare/docker-compose.scenario-b.yml \
#                  up -d

services:
  superset-scenario-b:
    image: apache/superset:4.0.2
    container_name: iris-pgwire-superset-scenario-b
    ports:
      - "8089:8088"  # Different port to avoid conflict with Scenario A
    environment:
      - SUPERSET_SECRET_KEY=superset_secret_key_scenario_b
      - DATABASE_DB=superset
      - DATABASE_HOST=postgres-scenario-b
      - DATABASE_PASSWORD=superset
      - DATABASE_USER=superset
      - REDIS_HOST=redis-scenario-b
      - REDIS_PORT=6379
    volumes:
      - ./scenario-b/superset_config.py:/app/pythonpath/superset_config.py:ro
      - ./scenario-b/install-iris-driver.sh:/app/docker/install-iris-driver.sh:ro
      - ./scenario-b/init-superset-scenario-b.sh:/app/docker/docker-init.sh:ro
      - ./data:/app/data:ro
    networks:
      - iris-pgwire
    depends_on:
      postgres-scenario-b:
        condition: service_healthy
      redis-scenario-b:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    command: >
      bash -c "
      /app/docker/install-iris-driver.sh &&
      /app/docker/docker-init.sh &&
      gunicorn --bind 0.0.0.0:8088 --workers 4 --timeout 120 --limit-request-line 0 --limit-request-field_size 0 'superset.app:create_app()'
      "

  postgres-scenario-b:
    image: postgres:16-alpine
    container_name: iris-pgwire-superset-db-scenario-b
    environment:
      - POSTGRES_DB=superset
      - POSTGRES_USER=superset
      - POSTGRES_PASSWORD=superset
    volumes:
      - postgres-data-scenario-b:/var/lib/postgresql/data
    networks:
      - iris-pgwire
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U superset"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-scenario-b:
    image: redis:7-alpine
    container_name: iris-pgwire-redis-scenario-b
    networks:
      - iris-pgwire
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres-data-scenario-b:
    name: iris-pgwire-superset-postgres-scenario-b

networks:
  iris-pgwire:
    external: true
    name: iris-pgwire-network
